# MERN Project example and notes

Personal project and notes on this basic mern project. This is a very simple project and its only function is to allow user to sign up and log in. 


## How to get started with the project

1. Download whole project, add .env file for sensitive data
2. Install libraries: `npm install && cd client && npm install`
3. Use `npm start` and `npm run dev` can both run front end and backend. The difference between them is that `npm run dev` use nodemon, which dynamically run the backend. If the development is for front end, `npm run start` runs faster when updating UI.

## Env

There are three files related to environment variables. The PROD version should keep data in the first two files in web settings.

1. server/config.env.js: Default app configs for express, including mongodb uri, port, domain, and sessionCookie.
2. .env: All sensitive data such as api keys. This file should be ignored by git for security reasons.
3. json: temporary environment for vscode debugger. Usually used for temporarily using PROD mode for spapi. This file should be ignored by git.
```
{
  "version": "0.2.0",
  "configurations": [{
  "command": "npm run dev",
  "name": "npm dev",
  "request": "launch",
  "type": "node-terminal",
  "env":{"MODE":"PROD"}
}]
}
```
## Structure

Frontend and backend have different libraries and scripts. Please make sure to install libraries in the right folder.

listingMgmt

- client: front end codes
  - build: generated by react-scripts build(run "npm run build")
  - Node\_modules: front end library
  - public: static files for base html,icons, and images.
  - **src** : react codes
    - components: folders for react components, js and scss included
    - context: react contexts
    - js: core js handling routes and components
    - css: core css for every files
    - Other settings
  - .env: set port or other react environment
  - json, .etc
- node\_modules: backend library
- server: back end codes
  - config: all configs and env for running the backend.
    - Strategies: login strategies (for passport.js)
    - Other configurations for express, mongoose, .etc.
  - Modules

Please notice that all files should be in the right folder. Otherwise the express won't be able to load them.

    - [moduleName]
      - controllers
      - models
      - policies
      - routes
  - index.js: backend start script
  - start-client.js: frontend start script
- json and other settings, e.g. gitignore, eslintrc, prettierrc, .etc.


## front end 
Create app by using `npx create-react-app my-app` and it shall handle every basic funcion for running a React app. I have added `sass` for styles and `react-router-dom` for client side routes. 

Other helpful libs to be added in the future  
Styled components: styles for customed components   
Redux: control states  
Nextjs: styling and routes  

### link front end with back end
To keep front end and back end in the sam repository and use same host, I use proxy to link front end and back end.

In front end, set `"proxy": "http://localhost:8090/",` in `package.json`. 

In Back end, when running express, send root html for every pages. In order not to send the html file when using `/api/[route]`, remember to run the sendFile function after running all back end routes.
```
if (process.env.NODE_ENV === "production") {
    app.use(express.static(path.resolve(__dirname, "../../client/build")));
    app.get("*", (req, res) => {
      res.sendFile(path.resolve(__dirname, "../../client", "build", "index.html"));
    });
  } else {
    app.use(express.static(path.resolve(__dirname, "../../client/build")));
  }
```

## back end
The back end is a little complex. The server uses mongoose, express, and node. It archieves all js files by modules, which means all user controllers, models, policies, and routes should be in the same folder called users. This means the server needs to automatically find and run all routes, policies, and load mongodb models.

### How back end server runs
1. (/server/index.js)
2. (/server/config/config.js) initGlobalConfig: use glob to find all models, routes, policies acoording to assets (/server/config/assets.js)
3. (/server/config/mongoose.js) mongooseService.connect
4. (/server/config/mongoose.js) mongooseService.loadModels
5. (/server/config/express.js) expressConfig.init: init dotenv, init local variables, express middleware, express session, passport (for log in), policies, routes, client routes

*order matters in express initiation*

### login and logout
the lib [passport](https://www.npmjs.com/package/passport) is used for login and log out. 

#### init passport
(/server/config/express.js) after express session is init, init passport.

```
  // Add passport's middleware
  app.use(passport.initialize());
  app.use(passport.session());

  // Initialize strategies
  config.utils.getGlobbedPaths(path.join(__dirname, "./strategies/**/*.js")).forEach(function (strategy) {
    require(path.resolve(strategy))(config);
  });

  // Serialize sessions
  passport.serializeUser(function (user, done) {
    done(null, user.id);
  });

  // Deserialize sessions
  passport.deserializeUser(function (id, done) {
    require("mongoose")
      .model("User")
      .findOne(
        {
          _id: id,
        },
        "-salt -password",
        function (err, user) {
          done(err, user);
        }
      );
  });
```

#### log in
```
passport.authenticate("local", function (err, user, info) {
    if (err || !user) {
      res.status(422).send(info);
    } else {
      // Remove sensitive data before login
      user.password = undefined;
      req.login(user, function (err) {
        if (err) {
          res.status(400).send(err);
        } else {
          res.json(user);
        }
      });
    }
  })(req, res, next);
```
#### log out
```
passport.authenticate("local", function (err, user, info) {
    req.logout(function (err) {
      if (err) {
        return next(err);
      }
      res.redirect("/");
    });
  })(req, res, next);
```
#### store login session in database instead of memory
required lib: `connect-mongo`
If login session is stored in memory, user needs to log in again after rerun the server.

```
const MongoStore = require("connect-mongo");
...
app.use(session({
          store: MongoStore.create({client: db.connection.getClient(),collectionName: config.sessionCollection,}),
      }))
```
